<div class="container" style="padding:40px; background-color: #ffffff; box-shadow: 1px 1px 5px #acacac; border-radius: 10px; font-family: Gadugi, Arial, sans-serif">
    <form action="/test" method="get" enctype="multipart/form-data">
        <div class="form-row mb-4">
            <div class="col">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Cold Storage</span>
                    </div>
                    <select name="in_cold_id" id="cold-name-list" class="form-control" oninput="showModal(this.value, '#newCold_Modal')">
                        <option disabled selected>Select Cold Store Name</option>
                        {{#coldStore}}
                        <option value="{{_id}}">{{name}}</option>
                        {{/coldStore}}
                        <option value="add">Add New Cold Store</option>
                    </select>
                </div>
            </div>
            <div class="col-sm-4">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Date</span>
                    </div>
                    <input type="date" class="form-control" name="in_date" required>
                </div>
            </div>
        </div>
        <div class="form-row mb-4">
            <div class="col">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Seller Name</span>
                    </div>
                    <select name="in_seller_id" id="seller-name-list" class="form-control" oninput="showModal(this.value, '#newSeller_Modal')">
                        <option disabled selected>Select Seller Name</option>
                        {{#seller}}
                        <option value="{{_id}}">{{name}}</option>
                        {{/seller}}
                        <option value="add">Add New Seller</option>
                    </select>
                </div>
            </div>
            <div class="col">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Buyer Name</span>
                    </div>
                    <input type="text" class="form-control" placeholder="Buyer Name & Address" list="buyer-name" onfocusout="getBuyerMobile()" id="buyer-name-input" name="in_buyer_name" required>
                </div>
                <datalist id="buyer-name">
                    <option value="Nem Singh">
                    <option value="Mahesh Chand">
                </datalist>
            </div>
        </div>
        <hr>
        <div id="purchase_detail">
            <div class="form-row mb-4">
                <div class="col">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text">Lot No.</span>
                        </div>
                        <input type="text" class="form-control" placeholder="Lot Number" name="in_lot" required>
                    </div>
                </div>
                <div class="col">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text">Type</span>
                        </div>
                        <select class="form-control" name="in_size">
                            <option disabled selected>Potato Size</option>
                            <option value="Gulla">Gulla</option>
                            <option value="Mota">Mota</option>
                            <option value="Kirri">Kirri</option>
                        </select>
                    </div>
                </div>
                <div class="col">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text">Packets</span>
                        </div>
                        <input type="text" class="form-control" placeholder="Bags" name="in_bags" required pattern="[0-9]+" title="Enter Number Of Packets!">
                    </div>
                </div>
                <div class="col">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text">Rate</span>
                        </div>
                        <input type="text" class="form-control" placeholder="Rate" name="in_rate" required pattern="[-+]?[0-9]*[.,]?[0-9]+" title="Rate Not Valid!">
                    </div>
                </div>
                <div class="col">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text">Tol</span>
                        </div>
                        <select class="form-control" name="in_tol">
                            <option disabled selected>Select Tol</option>
                            <option value="52.5">52.5 Kg/Bag</option>
                            <option value="52.3">52.3 Kg/Bag</option>
                            <option value="52.7">52.7 Kg/Bag</option>
                        </select>
                    </div>
                </div>
                <div class="col-sm-offset-10">
                    <button class="btn btn-primary" style="width: 2.5em" onclick="addRow()">+</button>
                </div>
            </div>
        </div>
        <div class="form-row">
            <div class="col">
                <div class="custom-file">
                    <input type="file" class="custom-file-input" id="customFile" name="in_files" multiple accept="image/*" onchange="setFileInputText()">
                    <label class="custom-file-label" for="customFile" id="fileLabel">Choose Files (Max 5 Files)</label>
                </div>
            </div>
            <div class="col-sm-2">
                <button type="submit" class="btn btn-success col" onclick="applyValidation()">Save</button>
            </div>
        </div>
    </form>
</div>
<div class="modal fade" id="newCold_Modal">
    <form id="newCold_Form" action="#" onsubmit="saveNewColdDetails()">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Add New Cold Store</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row mb-4 mt-2 mr-5 ml-5">
                    <div class="col">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">Cold Storage</span>
                            </div>
                            <input type="text" class="form-control" placeholder="Cold Storage Name" title="Provide Cold Name!" id="cold-name" required>
                        </div>
                    </div>
                </div>
                <div class="form-row mb-4 mr-5 ml-5">
                    <div class="col">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">Bags</span>
                            </div>
                            <input type="text" class="form-control" placeholder="Bags Already Stored" pattern="[0-9]+" title="Enter Number Of Bags!" id="bag" required>
                        </div>
                    </div>
                </div>
                <div class="form-row mb-2 mr-5 ml-5">
                    <div class="col">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">Dues</span>
                            </div>
                            <input type="text" class="form-control" placeholder="Any Due Amount" pattern="[0-9]+" title="Enter Due Amount!" id="due" required>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div id="new-cold-progress" class="col m-font"></div>
                <button type="submit" class="btn btn-success col-sm-3">Save</button>
            </div>
        </div>
    </div>
    </form>
</div>
<div class="modal fade" id="newSeller_Modal" onsubmit="saveNewSellerDetails()">
    <form action="#" id="newSeller_Form">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Add New Seller</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row mb-4 mt-2 mr-5 ml-5">
                    <div class="col">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">Seller</span>
                            </div>
                            <input type="text" class="form-control" placeholder="Seller Name" title="Provide Seller Name!" id="seller-name" required>
                        </div>
                    </div>
                </div>
                <div class="form-row mb-4 mr-5 ml-5">
                    <div class="col">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">Address</span>
                            </div>
                            <input type="text" class="form-control" placeholder="Address" title="Enter Valid Address" id="address" required>
                        </div>
                    </div>
                </div>
                <div class="form-row mb-2 mr-5 ml-5">
                    <div class="col">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">Mobile</span>
                            </div>
                            <input type="text" class="form-control" placeholder="Mobile Number" pattern="[0-9]+" title="Enter Valid Mobile Number" id="mobile">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div id="new-seller-progress" class="col m-font"></div>
                <button type="submit" class="btn btn-success col-sm-3">Save</button>
            </div>
        </div>
    </div>
    </form>
</div>
<div class="modal fade" id="alertModal" role="dialog">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="info-modal-header"></h4>
                <button class="close" data-dismiss="modal" type="button">&times;</button>
            </div>
            <div class="modal-body">
                <p id="info-model-message"></p>
            </div>
            <div class="modal-footer" id="info-modal-footer">
                <button class="btn btn-success" data-dismiss="modal" id="info-modal-action-button"
                        type="button"></button>
                <button class="btn btn-primary" data-dismiss="modal" type="button">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="purchase_template" class="d-none">
    <div class="form-row mb-4">
        <div class="col">
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">Lot No.</span>
                </div>
                <input type="text" class="form-control" placeholder="Lot Number" name="in_lot" required>
            </div>
        </div>
        <div class="col">
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">Type</span>
                </div>
                <select class="form-control" name="in_size">
                    <option disabled selected>Potato Size</option>
                    <option value="Gulla">Gulla</option>
                    <option value="Mota">Mota</option>
                    <option value="Kirri">Kirri</option>
                </select>
            </div>
        </div>
        <div class="col">
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">Packets</span>
                </div>
                <input type="text" class="form-control" placeholder="Bags" name="in_bags" required pattern="[0-9]+" title="Enter Number Of Packets!">
            </div>
        </div>
        <div class="col">
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">Rate</span>
                </div>
                <input type="text" class="form-control" placeholder="Rate" name="in_rate" required pattern="[-+]?[0-9]*[.,]?[0-9]+" title="Rate Not Valid!">
            </div>
        </div>
        <div class="col">
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">Tol</span>
                </div>
                <select class="form-control" name="in_tol">
                    <option disabled selected>Select Tol</option>
                    <option value="52.5">52.5 Kg/Bag</option>
                    <option value="52.3">52.3 Kg/Bag</option>
                    <option value="52.7">52.7 Kg/Bag</option>
                </select>
            </div>
        </div>
        <div class="col-lg-push-0">
            <button class="btn btn-primary" style="width: 2.5em" onclick="removeRow(this)">-</button>
        </div>
    </div>
</div>

<script>
    //UI Handling Functions
    $(document).ready(function() {
        setModalProperties();
    });
    function addRow() {
        let table = document.getElementById("purchase_detail");
        let template = document.createElement('template');
        template.innerHTML = document.getElementById("purchase_template").innerHTML;
        let node = template.content.cloneNode(true);
        table.appendChild(node);
    }
    function removeRow(child){
        let table = document.getElementById("purchase_detail");
        table.removeChild(child.parentElement.parentElement);
    }
    function validateDropDown(input){
        if(input.selectedIndex==0 || input.selectedIndex==-1)
            input.setCustomValidity('Please Select A Valid Option!');
        else
            input.setCustomValidity('');
    }
    function applyValidation(){
        let coldList=document.getElementById("cold-name-list");
        let pType=document.getElementById("type");
        let tol=document.getElementById("tol");
        let filePicker=document.getElementById("customFile");

        validateDropDown(coldList);
        validateDropDown(pType);
        validateDropDown(tol);

        if(filePicker.files.length>5)
            filePicker.setCustomValidity('Maximum 5 Files Allowed!');
        else
            filePicker.setCustomValidity('');
    }
    function setFileInputText(){
        let label=document.getElementById("fileLabel");
        let fileInput=document.getElementById("customFile");
        if(fileInput.files.length>0){
            label.innerHTML=fileInput.files.length+' Files Selected';
        }else {
            label.innerHTML='Choose Files (Max 5 Files)';
        }
    }

    function setModalProperties(){
        $("#newCold_Modal").on('show.bs.modal', function () {
            document.getElementById("newCold_Form").reset();
            document.getElementById("new-cold-progress").innerHTML="";
        });
        $("#newCold_Modal").on('hidden.bs.modal', function () {
            document.getElementById("cold-name-list").selectedIndex=0;
        });

        $("#newSeller_Modal").on('show.bs.modal', function () {
            document.getElementById("newSeller_Form").reset();
            document.getElementById("new-seller-progress").innerHTML="";
        });
        $("#newSeller_Modal").on('hidden.bs.modal', function () {
            document.getElementById("seller-name-list").selectedIndex=0;
        });

    }
    function showModal(option, modalId){
        if(option==='add')
            $(modalId).modal('show');
    }
</script>

<script>
    //Ajax calls to APIs
    function saveNewColdDetails(){
        document.getElementById('new-cold-progress').innerHTML="<i class='fa fa-2x fa-spinner fa-pulse'></i>";
        $.ajax('/api/save_new_cold', {
            type: 'POST',
            data: {
                name: $('#cold-name').val(),
                bag: $('#bag').val(),
                due:$('#due').val()
            },
            success: function (data, status, xhr) {
                let nameList=document.getElementById('cold-name-list');
                let newOption = document.createElement("option");
                newOption.value=data.insertedId;
                newOption.innerHTML = data.name;
                nameList.insertBefore(newOption, nameList.lastElementChild);
                $("#newCold_Modal").modal('hide');
            },
            error: function (jqXhr, textStatus, errorMessage) {
                document.getElementById('new-cold-progress').innerHTML=errorMessage+" : Can't Save Cold Details!";
            }
        });
    }

    function saveNewSellerDetails(){
        document.getElementById('new-seller-progress').innerHTML="<i class='fa fa-2x fa-spinner fa-pulse'></i>";
        $.ajax('/api/save_new_seller', {
            type: 'POST',
            data: {
                name: $('#seller-name').val(),
                address: $('#address').val(),
                mobile:$('#mobile').val()
            },
            success: function (data, status, xhr) {
                let nameList=document.getElementById('seller-name-list');
                let newOption = document.createElement("option");
                newOption.value=data.insertedId;
                newOption.innerHTML = data.name+" "+data.address+" "+data.mobile;
                nameList.insertBefore(newOption, nameList.lastElementChild);
                $("#newSeller_Modal").modal('hide');
            },
            error: function (jqXhr, textStatus, errorMessage) {
                document.getElementById('new-seller-progress').innerHTML=errorMessage+" : Can't Save Seller Details!";
            }
        });
    }

</script>

<script>
let messages={
        error:"<i style='color: #db3000' class=\"fa fa-times-circle-o fa-lg\" aria-hidden=\"true\"></i> Can't Save The Record! ",
        success:"<i style='color: #4cae4c' class=\"fa fa-check-circle-o fa-lg\" aria-hidden=\"true\"></i> Record Saved Successfully! "
    }

</script>

</html>